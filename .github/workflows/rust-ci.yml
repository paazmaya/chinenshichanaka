# https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions

name: Rust CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Rust
        run: rustup update stable

      - name: Install clippy
        run: rustup component add clippy

      - name: Run clippy
        # https://github.com/rust-lang/rust-clippy
        run: cargo clippy -- -D warnings

      - name: Build
        run: cargo build

      - name: Install tarpaulin
        # A code coverage tool for Rust projects
        # https://github.com/xd009642/tarpaulin
        run: cargo install cargo-tarpaulin --locked

      - name: Measure code coverage
        # Skip removing executable before compilation so cli can be tested
        run: cargo tarpaulin --out xml --follow-exec --skip-clean

      - name: Upload code coverage to codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: cobertura.xml  # The name of the coverage report generated by tarpaulin

      #- name: Upload coverage information to codacy
        # https://github.com/codacy/codacy-coverage-reporter-action
      #  uses: codacy/codacy-coverage-reporter-action@v1.3.0
      #  with:
      #    project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
      #    coverage-reports: cobertura.xml

      - name: Package to be installable
        # https://github.com/crabnebula-dev/cargo-packager
        run: |
          cargo install cargo-packager --locked
          cargo packager --release --verbose

      - name: Store package installer artifacts
        uses: actions/upload-artifact@v4
        with:
          name: installers
          path: |
            packages/
            !packages/.cargo-packager